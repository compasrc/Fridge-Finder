// -----------------
// Helper Functions
// -----------------

async function loadRecipes() {
  console.log('Loading recipes from TheMealDB...');
  return await RemoteRecipes.loadDiverseRecipes();
}

function getAllIngredients(recipes) {
  const ingredients = new Set();
  recipes.forEach(recipe => {
    recipe.ingredients.forEach(ingredient => {
      // Normalize ingredient by removing trailing 's' for common plurals
      let normalized = ingredient.toLowerCase().trim();
      
      // Simple pluralization handling - remove trailing 's' or 'es'
      if (normalized.endsWith('s') && normalized.length > 3) {
        // Don't remove 's' from words that should stay plural (like 'peas', 'lentils')
        const keepPlural = ['peas', 'beans', 'lentils', 'oats', 'grits', 'olives'];
        if (!keepPlural.includes(normalized)) {
          // Check if it ends with 'es' or just 's'
          if (normalized.endsWith('es') && normalized.length > 4) {
            // For words ending in 'oes', 'ies', 'ches', 'shes', remove 'es'
            const beforeEs = normalized.slice(-3, -2);
            if (['o', 'h'].includes(beforeEs) || normalized.endsWith('ies')) {
              normalized = normalized.slice(0, -2);
            } else {
              normalized = normalized.slice(0, -1);
            }
          } else {
            normalized = normalized.slice(0, -1);
          }
        }
      }
      
      ingredients.add(normalized);
    });
  });
  return Array.from(ingredients).sort();
}

function categorizeIngredients(ingredients) {
  const categories = {
    'Proteins': [],
    'Dairy & Eggs': [],
    'Vegetables': [],
    'Fruits': [],
    'Grains & Pasta': [],
    'Herbs & Spices': [],
    'Condiments & Oils': [],
    'Other': []
  };

  const categoryMap = {
    // Proteins
    'chicken': 'Proteins', 'beef': 'Proteins', 'pork': 'Proteins', 'lamb': 'Proteins',
    'fish': 'Proteins', 'salmon': 'Proteins', 'tuna': 'Proteins', 'cod': 'Proteins',
    'shrimp': 'Proteins', 'prawn': 'Proteins', 'bacon': 'Proteins', 'sausage': 'Proteins',
    'turkey': 'Proteins', 'duck': 'Proteins', 'ham': 'Proteins',
    
    // Dairy & Eggs
    'cheese': 'Dairy & Eggs', 'milk': 'Dairy & Eggs', 'butter': 'Dairy & Eggs', 
    'cream': 'Dairy & Eggs', 'yogurt': 'Dairy & Eggs', 'egg': 'Dairy & Eggs',
    'parmesan': 'Dairy & Eggs', 'mozzarella': 'Dairy & Eggs', 'cheddar': 'Dairy & Eggs',
    
    // Vegetables
    'tomato': 'Vegetables', 'onion': 'Vegetables', 'garlic': 'Vegetables', 
    'potato': 'Vegetables', 'carrot': 'Vegetables', 'pepper': 'Vegetables',
    'mushroom': 'Vegetables', 'broccoli': 'Vegetables', 'spinach': 'Vegetables',
    'celery': 'Vegetables', 'lettuce': 'Vegetables', 'cucumber': 'Vegetables',
    'zucchini': 'Vegetables', 'eggplant': 'Vegetables', 'cabbage': 'Vegetables',
    'peas': 'Vegetables', 'beans': 'Vegetables', 'corn': 'Vegetables',
    
    // Fruits
    'lemon': 'Fruits', 'lime': 'Fruits', 'apple': 'Fruits', 'banana': 'Fruits',
    'orange': 'Fruits', 'strawberry': 'Fruits', 'avocado': 'Fruits',
    'tomatoes': 'Fruits', 'olives': 'Fruits',
    
    // Grains & Pasta
    'rice': 'Grains & Pasta', 'pasta': 'Grains & Pasta', 'noodle': 'Grains & Pasta',
    'bread': 'Grains & Pasta', 'flour': 'Grains & Pasta', 'oats': 'Grains & Pasta',
    'couscous': 'Grains & Pasta', 'quinoa': 'Grains & Pasta',
    
    // Herbs & Spices
    'basil': 'Herbs & Spices', 'oregano': 'Herbs & Spices', 'thyme': 'Herbs & Spices',
    'rosemary': 'Herbs & Spices', 'parsley': 'Herbs & Spices', 'cilantro': 'Herbs & Spices',
    'mint': 'Herbs & Spices', 'sage': 'Herbs & Spices', 'dill': 'Herbs & Spices',
    'paprika': 'Herbs & Spices', 'cumin': 'Herbs & Spices', 'coriander': 'Herbs & Spices',
    'curry': 'Herbs & Spices', 'chili': 'Herbs & Spices', 'ginger': 'Herbs & Spices',
    'cinnamon': 'Herbs & Spices', 'nutmeg': 'Herbs & Spices', 'pepper': 'Herbs & Spices',
    
    // Condiments & Oils
    'oil': 'Condiments & Oils', 'olive oil': 'Condiments & Oils', 'vinegar': 'Condiments & Oils',
    'soy sauce': 'Condiments & Oils', 'sauce': 'Condiments & Oils', 'stock': 'Condiments & Oils',
    'broth': 'Condiments & Oils', 'ketchup': 'Condiments & Oils', 'mustard': 'Condiments & Oils',
    'mayonnaise': 'Condiments & Oils', 'honey': 'Condiments & Oils', 'sugar': 'Condiments & Oils',
    'salt': 'Condiments & Oils', 'wine': 'Condiments & Oils'
  };

  ingredients.forEach(ingredient => {
    let categorized = false;
    
    // Check if ingredient matches any key in categoryMap
    for (const [key, category] of Object.entries(categoryMap)) {
      if (ingredient.includes(key)) {
        categories[category].push(ingredient);
        categorized = true;
        break;
      }
    }
    
    if (!categorized) {
      categories['Other'].push(ingredient);
    }
  });

  // Sort ingredients within each category and remove empty categories
  const result = {};
  for (const [category, items] of Object.entries(categories)) {
    if (items.length > 0) {
      result[category] = items.sort();
    }
  }
  
  return result;
}

function createIngredientBoxes(ingredients) {
  const container = document.getElementById("ingredients-container");
  container.innerHTML = "";
  
  if (ingredients.length === 0) {
    container.innerHTML = '<p style="color: #B8732E;">No ingredients available. Please check your recipes.json file.</p>';
    return;
  }
  
  const categorized = categorizeIngredients(ingredients);
  
  // Create sections for each category
  for (const [category, items] of Object.entries(categorized)) {
    const categorySection = document.createElement("div");
    categorySection.className = "ingredient-category";
    
    const categoryTitle = document.createElement("h3");
    categoryTitle.className = "category-title";
    categoryTitle.textContent = category;
    categorySection.appendChild(categoryTitle);
    
    const categoryGrid = document.createElement("div");
    categoryGrid.className = "ingredient-grid";
    
    items.forEach(ingredient => {
      const box = document.createElement("div");
      box.className = "ingredient-box";
      box.textContent = ingredient;
      box.addEventListener("click", () => box.classList.toggle("selected"));
      categoryGrid.appendChild(box);
    });
    
    categorySection.appendChild(categoryGrid);
    container.appendChild(categorySection);
  }
}

function getSelectedIngredients() {
  return Array.from(document.querySelectorAll(".ingredient-box.selected"))
              .map(box => box.textContent.toLowerCase());
}

function getSelectedAllergens() {
  return Array.from(document.querySelectorAll(".allergy-filter:checked"))
              .map(box => box.value.toLowerCase());
}

// -----------------
// Recipe Filtering
// -----------------
function findRecipes(userIngredients, recipes, selectedAllergens) {
  if (userIngredients.length === 0) return [];

  return recipes
    .map(recipe => {
      const recipeIngredients = recipe.ingredients.map(i => i.toLowerCase());

      // exclude allergens
      for (const allergen of selectedAllergens) {
        if (recipeIngredients.some(i => {
          if (allergen === "gluten") return i.includes("bread") || i.includes("pasta") || i.includes("naan");
          if (allergen === "nuts") return i.includes("nuts") || i.includes("peanut") || i.includes("almond");
          if (allergen === "dairy") return i.includes("cheese") || i.includes("milk") || i.includes("butter");
          return false;
        })) return null;
      }

      // Calculate how many ingredients the user has
      const matchCount = recipeIngredients.filter(i => userIngredients.includes(i)).length;
      const matchRatio = matchCount / recipeIngredients.length;

      // Return recipe with match score
      return { recipe, matchRatio, matchCount, totalIngredients: recipeIngredients.length };
    })
    .filter(item => item !== null && item.matchRatio >= 0.5) // Show recipes where user has at least 50% of ingredients
    .sort((a, b) => b.matchRatio - a.matchRatio) // Sort by best match first
    .map(item => item.recipe);
}

// -----------------
// Render Recipes
// -----------------
let currentResults = [];
let allRecipes = [];

function renderRecipes(recipes) {
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";

  if (recipes.length === 0) {
    resultsDiv.innerHTML = '<div class="no-results">No matches found. Try selecting different ingredients!</div>';
    return;
  }

  recipes.forEach(recipe => {
    const card = document.createElement("div");
    card.className = "recipe-card";

    const favButton = document.createElement("button");
    favButton.textContent = localStorage.getItem(recipe.name) ? "★ Favorited" : "☆ Favorite";
    favButton.className = "fav-btn";
    favButton.addEventListener("click", () => toggleFavorite(recipe));

    // Format ingredients with line breaks
    const ingredientsList = recipe.ingredientsWithMeasures 
      ? recipe.ingredientsWithMeasures.map(ing => `• ${ing}`).join('<br>')
      : recipe.ingredients.map(ing => `• ${ing}`).join('<br>');

    // Preserve newlines in instructions
    const formattedInstructions = recipe.instructions.replace(/\n/g, '<br>');

    card.innerHTML = `
      <h3>${recipe.name}</h3>
      <div class="ingredients-list">
        <strong>Ingredients:</strong><br>
        ${ingredientsList}
      </div>
      <div class="instructions-section">
        <strong>Instructions:</strong><br>
        ${formattedInstructions}
      </div>
    `;
    card.appendChild(favButton);
    resultsDiv.appendChild(card);
  });
}

// -----------------
// Favorites
// -----------------
function toggleFavorite(recipe) {
  const key = recipe.name;
  if (localStorage.getItem(key)) {
    localStorage.removeItem(key);
  } else {
    localStorage.setItem(key, JSON.stringify(recipe));
  }
  renderRecipes(currentResults);
  renderFavorites();
}

function renderFavorites() {
  const favoritesDiv = document.getElementById("favorites");
  favoritesDiv.innerHTML = "";

  const favoriteRecipes = Object.keys(localStorage)
    .filter(key => {
      try {
        const item = JSON.parse(localStorage.getItem(key));
        return item && item.name && item.ingredients;
      } catch {
        return false;
      }
    })
    .map(key => JSON.parse(localStorage.getItem(key)));

  if (favoriteRecipes.length === 0) {
    favoritesDiv.innerHTML = '<div class="no-results">No favorite recipes yet. Click the ☆ button to add favorites!</div>';
    return;
  }

  favoriteRecipes.forEach(recipe => {
    const card = document.createElement("div");
    card.className = "recipe-card";
    
    const unfavButton = document.createElement("button");
    unfavButton.textContent = "★ Remove";
    unfavButton.className = "fav-btn";
    unfavButton.addEventListener("click", () => {
      localStorage.removeItem(recipe.name);
      renderFavorites();
      if (currentResults.length > 0) renderRecipes(currentResults);
    });
    
    // Format ingredients with line breaks
    const ingredientsList = recipe.ingredientsWithMeasures 
      ? recipe.ingredientsWithMeasures.map(ing => `• ${ing}`).join('<br>')
      : recipe.ingredients.map(ing => `• ${ing}`).join('<br>');
    
    // Preserve newlines in instructions
    const formattedInstructions = recipe.instructions.replace(/\n/g, '<br>');
    
    card.innerHTML = `
      <h3>${recipe.name}</h3>
      <div class="ingredients-list">
        <strong>Ingredients:</strong><br>
        ${ingredientsList}
      </div>
      <div class="instructions-section">
        <strong>Instructions:</strong><br>
        ${formattedInstructions}
      </div>
    `;
    card.appendChild(unfavButton);
    favoritesDiv.appendChild(card);
  });
}

// -----------------
// Initialize & Search
// -----------------
async function initializeApp() {
  console.log("Initializing app...");
  allRecipes = await loadRecipes();
  console.log("Loaded recipes:", allRecipes);
  
  const allIngredients = getAllIngredients(allRecipes);
  console.log("All ingredients:", allIngredients);
  
  createIngredientBoxes(allIngredients);
  renderFavorites();
  
  // Wire up toggle functionality
  setupDataSourceToggle();
  
  console.log("App initialized successfully!");
}

function setupDataSourceToggle() {
  const refreshBtn = document.getElementById('refresh-remote-btn');
  const selectAllBtn = document.getElementById('select-all-btn');
  
  refreshBtn.disabled = false;
  
  refreshBtn.addEventListener('click', async () => {
    console.log('Refreshing remote recipes...');
    refreshBtn.disabled = true;
    refreshBtn.textContent = 'Loading...';
    
    try {
      allRecipes = await loadRecipes();
      console.log('Loaded recipes:', allRecipes.length);
      
      const allIngredients = getAllIngredients(allRecipes);
      console.log('All ingredients:', allIngredients.length);
      
      createIngredientBoxes(allIngredients);
      
      refreshBtn.textContent = 'Refresh remote data';
      refreshBtn.disabled = false;
      alert(`Remote recipes refreshed! Loaded ${allRecipes.length} recipes with ${allIngredients.length} unique ingredients.`);
    } catch (error) {
      console.error('Error refreshing recipes:', error);
      refreshBtn.textContent = 'Refresh remote data';
      refreshBtn.disabled = false;
      alert('Failed to refresh recipes. Check console for details.');
    }
  });
  
  selectAllBtn.addEventListener('click', () => {
    const allBoxes = document.querySelectorAll('.ingredient-box');
    allBoxes.forEach(box => box.classList.add('selected'));
  });
}

async function performSearch() {
  const userIngredients = getSelectedIngredients();
  const selectedAllergens = getSelectedAllergens();

  if (userIngredients.length === 0) {
    alert("Please select at least one ingredient!");
    return;
  }

  currentResults = findRecipes(userIngredients, allRecipes, selectedAllergens);
  console.log("Search results:", currentResults);
  renderRecipes(currentResults);
}

// -----------------
// Event Listeners
// -----------------
document.getElementById("search-btn").addEventListener("click", performSearch);
window.addEventListener("load", initializeApp);
